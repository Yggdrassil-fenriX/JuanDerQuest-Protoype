<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JuanDer Quest</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Mapbox GL JS CSS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
    <!-- Mapbox GL JS - MOVED HERE TO ENSURE IT LOADS BEFORE CUSTOM SCRIPT -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    <style>
        /* Import Inter font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');
        .font-inter {
            font-family: 'Inter', sans-serif;
        }

        /* Custom animations for the Start Page */
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fade-in-up 1s ease-out forwards;
        }
        .animate-fade-in-up-delay {
            animation: fade-in-up 1s ease-out 0.5s forwards;
            opacity: 0; /* Start hidden */
        }
        @keyframes pop-in {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-pop-in {
            animation: pop-in 0.6s ease-out 1s forwards;
            opacity: 0; /* Start hidden */
        }

        /* CSS for the eco-themed progress bar animation */
        @keyframes fill-progress {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        .progress-bar-fill {
            animation: fill-progress 2s linear forwards; /* Matches the 2-second timeout */
        }

        /* Hide scrollbar for overflow-x-auto elements */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-emerald-50 to-green-100 font-inter text-gray-800 relative flex flex-col">

    <div id="app-root" class="min-h-screen flex flex-col">
        <!-- Content will be rendered here by JavaScript -->
    </div>

    <script>
        // Mapbox Access Token (Replace with your actual token)
        // You can get one from https://account.mapbox.com/access-tokens/
        mapboxgl.accessToken = 'pk.eyJ1IjoiYm9iYnluZDUiLCJhIjoiY2x4b3kzd29iMDRkczJrcW50a2x0cW56aSJ9.J_26n1e6L3n0m7gP_f8T1Q';

        // Global state variables
        let tokens = 100;
        let xp = 0;
        let level = 1;
        let completedQuests = {};
        let activeView = 'home'; // Default view after successful wallet connection
        let isNavOverlayOpen = false;
        let showStartPage = true;
        let selectedQuestId = null; // New state to store the ID of the selected quest for detail view
        let connectedWalletAddress = null; // New state for connected wallet address
        let username = ''; // New state for username
        let userLatitude = null; // User's current latitude
        let userLongitude = null; // User's current longitude
        let locationCheckStatus = 'idle'; // 'idle', 'checking', 'success', 'denied', 'error'
        let isInRange = false; // Whether the user is in range of the selected quest

        // XP thresholds for leveling up
        const LEVEL_THRESHOLDS = {
            1: 0, 2: 100, 3: 250, 4: 500, 5: 800, 6: 1200, 7: 1700, 8: 2300, 9: 3000, 10: 4000,
        };

        // Quest data with approximate coordinates
        const quests = [
            { id: 'tondalinis', category: 'Eco Quests', name: 'Tondalinis Cleanup', description: 'Collect 5 types of trash at Tondaligan Beach and upload a flex-worthy cleanup selfie.', location: 'Tondaligan Beach, Dagupan', rewardTokens: 50, rewardXp: 40, badge: 'Coastal Custodian', rating: 4.5, lat: 16.0500, lon: 120.3333 },
            { id: 'patar-patrol', category: 'Eco Quests', name: 'Patar Patrol: Basura Edition', description: 'Sweep Patar Beach clean and restore dune plants. Channel your inner beach ranger.', location: 'Patar Beach, Bolinao', rewardTokens: 60, rewardXp: 50, badge: 'Beach Ranger', rating: 4.8, lat: 16.3262, lon: 119.8279 },
            { id: 'dasol-dustoff', category: 'Eco Quests', name: 'Dasol Dust-Off', description: 'Bring your eco-bag and clean up Tambobong Beach. Bonus if you sort recyclables.', location: 'Tambobong, Dasol', rewardTokens: 55, rewardXp: 45, badge: 'Basura Buster', rating: 4.2, lat: 15.9833, lon: 119.8667 },
            { id: 'tanim-mo-token-ko', category: 'Green Quests', name: 'Tanim Mo, Token Ko!', description: 'Plant a mangrove seedling and make the environment your side hustle.', location: 'Bani Mangrove Eco Park', rewardTokens: 70, rewardXp: 60, badge: 'Mangrove Monarch NFT', rating: 4.9, lat: 16.2778, lon: 119.9500 },
            { id: 'juan-hundred-islands', category: 'Green Quests', name: 'Juan Hundred Islands', description: 'Visit 3 islands at Hundred Islands, complete eco-trivia per stop, and document it.', location: 'Hundred Islands, Alaminos', rewardTokens: 80, rewardXp: 70, badge: 'Island Explorer', rating: 4.7, lat: 16.2000, lon: 120.0000 },
            { id: 'hike-it-till-you-like-it', category: 'Green Quests', name: 'Hike It Till You Like It', description: 'Trek through Manleluag Springâ€™s forest trails while collecting trash.', location: 'Mangatarem', rewardTokens: 75, rewardXp: 65, badge: 'Trailblazer', rating: 4.3, lat: 15.7833, lon: 120.3500 },
            { id: 'fin-ish-the-quiz', category: 'Culture & Community Quests', name: 'Fin-ish the Quiz', description: 'Attend Bangus Festival and ace the in-app fishy trivia to win tokens.', location: 'Dagupan (During Bangus Festival)', rewardTokens: 40, rewardXp: 30, badge: 'Bangus Buff', rating: 4.0, lat: 16.0333, lon: 120.3333 },
            { id: 'lakbay-lokal', category: 'Culture & Community Quests', name: 'Lakbay Lokal', description: 'Visit 3 heritage sites in one day â€” GPS will do the checking, you do the JuanDering.', location: 'Lingayen Capitol, Bolinao Church, War Museum', rewardTokens: 90, rewardXp: 80, badge: 'Time Traveler SBT', rating: 4.6, lat: 16.0278, lon: 120.2286 },
            { id: 'juan-scan-away', category: 'Social & Event-Based Quests', name: 'Juan Scan Away', description: 'Join an LGU-organized clean-up or tree planting. Scan, plant, repeat.', location: 'Rotating barangays across Pangasinan (weekends only)', rewardTokens: 100, rewardXp: 90, badge: 'Bayanihan Boss', rating: 4.9, lat: 16.0333, lon: 120.3333 },
            { id: 'juander-together', category: 'Social & Event-Based Quests', name: 'JuanDer Together', description: 'Complete any quest with a friend. Upload a group photo + dual QR scan.', location: 'Anywhere, as long as you quest together', rewardTokens: 120, rewardXp: 100, badge: 'Friendship Flex', rating: 5.0, lat: null, lon: null }, // No specific location for range check
        ];

        // Haversine formula to calculate distance between two lat/lon points in kilometers
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of Earth in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c; // Distance in km
            return distance;
        }

        // Function to update level based on XP
        function updateLevel() {
            let newLevel = 1;
            for (const lvl in LEVEL_THRESHOLDS) {
                if (xp >= LEVEL_THRESHOLDS[lvl]) {
                    newLevel = parseInt(lvl);
                } else {
                    break;
                }
            }
            level = newLevel;
        }

        // Function to handle quest completion
        function handleCompleteQuest(questId) {
            const quest = quests.find(q => q.id === questId);
            if (quest && !completedQuests[questId]) {
                if (quest.lat && quest.lon) { // Only check location if quest has coordinates
                    if (isInRange) {
                        tokens += quest.rewardTokens;
                        xp += quest.rewardXp;
                        completedQuests[questId] = true;
                        updateLevel(); // Update level after XP changes
                        renderApp(); // Re-render the app to reflect changes
                        alert(`Quest "${quest.name}" completed! You earned ${quest.rewardTokens} tokens and ${quest.rewardXp} XP.`);
                    } else {
                        alert('You are not close enough to this quest location to complete it!');
                    }
                } else { // For quests without specific coordinates (e.g., "JuanDer Together")
                    tokens += quest.rewardTokens;
                    xp += quest.rewardXp;
                    completedQuests[questId] = true;
                    updateLevel();
                    renderApp();
                    alert(`Quest "${quest.name}" completed! You earned ${quest.rewardTokens} tokens and ${quest.rewardXp} XP.`);
                }
            } else if (completedQuests[questId]) {
                alert('You have already completed this quest!');
            }
        }

        // Function to simulate adding tokens
        function addTokens(amount, source) {
            tokens += amount;
            renderApp();
            alert(`You gained ${amount} tokens via ${source}!`);
        }

        // Function to simulate token redemption
        function redeemTokens(amount) {
            if (tokens >= amount) {
                tokens -= amount;
                renderApp();
                alert(`You redeemed ${amount} tokens for a discount!`);
            } else {
                alert('Not enough tokens to redeem.');
            }
        }

        // Function to simulate token donation
        function donateTokens(amount) {
            if (tokens >= amount) {
                tokens -= amount;
                renderApp();
                alert(`You donated ${amount} tokens to a heritage site! Thank you for your contribution.`);
            } else {
                alert('Not enough tokens to donate.');
            }
        }

        // Function to get user's current location
        function getUserLocation(callback) {
            locationCheckStatus = 'checking';
            renderApp(); // Update UI to show 'checking' status

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLatitude = position.coords.latitude;
                        userLongitude = position.coords.longitude;
                        locationCheckStatus = 'success';
                        if (callback) callback(true);
                        renderApp(); // Re-render to show location
                    },
                    (error) => {
                        console.error("Geolocation error:", error);
                        userLatitude = null;
                        userLongitude = null;
                        locationCheckStatus = 'error';
                        let errorMessage = "Error getting your location.";
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = "Location permission denied. Please enable location services for this site.";
                                locationCheckStatus = 'denied';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = "Location information is unavailable.";
                                break;
                            case error.TIMEOUT:
                                errorMessage = "The request to get user location timed out.";
                                break;
                        }
                        alert(errorMessage);
                        if (callback) callback(false);
                        renderApp(); // Re-render to show error/denied status
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                locationCheckStatus = 'error';
                alert("Geolocation is not supported by your browser.");
                if (callback) callback(false);
                renderApp(); // Re-render to show error
            }
        }

        // --- View Rendering Functions ---

        // Renders the Mobile Navigation Overlay
        function renderNavOverlay() {
            const buttonData = [
                { view: 'home', icon: 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m0 0l7 7m-2 2v-6a1 1 0 00-1-1H9a1 1 0 00-1 1v6m2-2h6', text: 'Home' },
                { view: 'quests', icon: 'M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01', text: 'Quests' },
                { view: 'profile', icon: 'M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z', text: 'Profile' },
                { view: 'token-utility', icon: 'M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z', text: 'Tokens' },
            ];

            return `
                <div id="nav-overlay" class="fixed inset-0 z-50 flex items-center justify-center transition-opacity duration-300
                    ${isNavOverlayOpen ? 'opacity-100 pointer-events-auto bg-black bg-opacity-50' : 'opacity-0 pointer-events-none bg-transparent'}">
                    <div class="nav-overlay-content grid grid-cols-2 gap-x-4 gap-y-4 p-4">
                        ${buttonData.map((button, index) => `
                            <button
                                data-view="${button.view}"
                                class="flex flex-col items-center justify-center w-20 h-20 rounded-full text-white font-bold text-sm
                                transition-all duration-300 transform shadow-lg
                                ${activeView === button.view ? 'bg-green-800 scale-110' : 'bg-green-700 hover:bg-green-600'}"
                                style="opacity: ${isNavOverlayOpen ? 1 : 0}; transform: ${isNavOverlayOpen ? 'scale(1)' : 'scale(0)'}; transition: all 0.3s ease-out ${isNavOverlayOpen ? index * 0.05 : (buttonData.length - 1 - index) * 0.05}s;"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="${button.icon}" />
                                </svg>
                                ${button.text}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Renders the Home View (now contains the interactive quest content)
        function renderHomeView() {
            return `
                <div class="p-0 bg-white rounded-xl shadow-lg mt-6 max-w-4xl mx-auto overflow-hidden">
                    <div class="relative w-full h-48 bg-gradient-to-b from-green-400 to-green-600 rounded-b-3xl overflow-hidden flex flex-col justify-end pb-4 px-4 shadow-md">
                        <img
                            src="https://via.placeholder.com/800x300/60A5FA/FFFFFF?text=Mountains"
                            alt="Mountains background"
                            class="absolute inset-0 w-full h-full object-cover opacity-80"
                            onerror="this.onerror=null;this.src='https://via.placeholder.com/800x300/A7F3D0/10B981?text=Mountains+Fallback';"
                        />
                        <div class="relative z-10 flex justify-between items-start mb-4">
                            <div class="flex items-center">
                                <img
                                    src="https://via.placeholder.com/50x50/FCA5A5/FFFFFF?text=User"
                                    alt="User Profile"
                                    class="w-12 h-12 rounded-full border-2 border-white shadow-md mr-3"
                                    onerror="this.onerror=null;this.src='https://via.placeholder.com/50x50/D1D5DB/FFFFFF?text=User';"
                                />
                                <div>
                                    <p class="text-white text-sm font-semibold">Welcome,</p>
                                    <p class="text-white text-xl font-bold">${username || 'JuanDerer Lengleng'}</p>
                                    <div class="flex items-center space-x-3 mt-1">
                                        <span class="text-white text-sm font-semibold flex items-center">
                                            ðŸ’° <span class="font-bold ml-1">${tokens}</span> Tokens
                                        </span>
                                        <span class="text-white text-sm font-semibold flex items-center">
                                            âœ¨ <span class="font-bold ml-1">${level}</span> Level
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <button class="p-2 rounded-full bg-white bg-opacity-30 text-white hover:bg-opacity-50 transition-all duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                                </svg>
                            </button>
                        </div>

                        <p class="relative z-10 text-white text-lg font-semibold mb-2">Where do you want to go?</p>
                        <div class="relative z-10 flex items-center bg-white rounded-full px-4 py-2 shadow-md">
                            <input
                                type="text"
                                placeholder="Explore now"
                                class="flex-grow bg-transparent outline-none text-gray-700 placeholder-gray-400"
                            />
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                    </div>

                    <!-- Category Icons -->
                    <div class="flex justify-around p-4 bg-white shadow-sm -mt-4 relative z-10 rounded-t-xl">
                        <div class="flex flex-col items-center text-green-700 font-semibold text-sm">
                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mb-1 shadow-md">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m-1 4h1m8-10h1m-1 4h1m-1 4h1m-10 4h.01M17 17h.01" />
                                </svg>
                            </div>
                            All
                        </div>
                        <div class="flex flex-col items-center text-gray-600 font-semibold text-sm">
                            <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mb-1 shadow-md">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m0 0l7 7m-2 2v-6a1 1 0 00-1-1H9a1 1 0 00-1 1v6m2-2h6" />
                                </svg>
                            </div>
                            Camping
                        </div>
                        <div class="flex flex-col items-center text-gray-600 font-semibold text-sm">
                            <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mb-1 shadow-md">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z" />
                                </svg>
                            </div>
                            Heritage
                        </div>
                        <div class="flex flex-col items-center text-gray-600 font-semibold text-sm">
                            <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mb-1 shadow-md">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 11-4 0 2 2 0 014 0z" />
                                </svg>
                            </div>
                            Shopping
                        </div>
                        <div class="flex flex-col items-center text-gray-600 font-semibold text-sm">
                            <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mb-1 shadow-md">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                            </div>
                            Adventure
                        </div>
                    </div>

                    <!-- Recommended Section -->
                    <div class="p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">Recommended</h3>
                            <button class="text-green-600 font-semibold text-sm hover:underline">See All</button>
                        </div>
                        <div class="flex overflow-x-auto space-x-4 pb-4 scrollbar-hide">
                            ${quests.map(quest => `
                                <div class="flex-shrink-0 w-48 bg-gray-50 rounded-lg shadow-md overflow-hidden border border-gray-200 cursor-pointer" data-quest-id="${quest.id}">
                                    <div class="w-full h-28 bg-green-200 flex items-center justify-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-green-600 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 15a4 4 0 004 4h9a5 5 0 005-5V7a4 4 0 00-4-4H8a4 4 0 00-4 4v2m0 0l-1 1h10l-1-1m-1 1a2 2 0 100 4m-4-4a2 2 0 100 4m-4-4a2 2 0 100 4m-4-4a2 2 0 100 4m-4-4a2 2 0 100 4m-4-4a2 2 0 100 4" />
                                        </svg>
                                    </div>
                                    <div class="p-3">
                                        <div class="flex items-center text-yellow-500 text-xs mb-1">
                                            ${Array.from({ length: 5 }).map((_, i) => `
                                                <svg key="${i}" class="h-4 w-4 ${i < Math.floor(quest.rating) ? 'text-yellow-500' : 'text-gray-300'}" fill="currentColor" viewBox="0 0 20 20">
                                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.538 1.118l-2.8-2.034a1 1 0 00-1.176 0l-2.8 2.034c-.783.57-1.838-.197-1.538-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.462a1 1 0 00.95-.69l1.07-3.292z" />
                                                </svg>
                                            `).join('')}
                                            <span class="ml-1 text-gray-600">(${quest.rating})</span>
                                        </div>
                                        <p class="font-semibold text-gray-800 text-sm mb-1">${quest.name}</p>
                                        <p class="text-gray-500 text-xs truncate">${quest.location}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Bottom Logo -->
                    <div class="flex justify-center p-4">
                        <img
                            src="https://via.placeholder.com/100x40/34D399/FFFFFF?text=JUANDER+QUEST"
                            alt="JuanDer Quest Logo"
                            class="w-24 h-auto"
                            onerror="this.onerror=null;this.src='https://via.placeholder.com/100x40/A7F3D0/10B981?text=Logo';"
                        />
                    </div>
                </div>
            `;
        }

        // Renders the Quests View (now contains the welcome content)
        function renderQuestsView() {
            return `
                <div class="p-6 bg-white rounded-xl shadow-lg mt-6 max-w-4xl mx-auto relative overflow-hidden">
                    <img
                        src="https://imgbin.com/png/pB38tXBZ/paper-scroll-png"
                        alt="Scroll background"
                        class="absolute inset-0 w-full h-full object-cover opacity-10 z-0 rounded-xl"
                    />
                    <div class="relative z-10">
                        <h2 class="text-3xl font-bold text-green-700 mb-4 text-center">Welcome, JuanDerer!</h2>
                        <p class="text-gray-700 text-lg mb-4 text-center">
                            Embark on your eco-adventure with JuanDer Quest. Complete quests, earn tokens, and make a real impact!
                        </p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                            <div class="bg-emerald-50 p-5 rounded-lg shadow-md border border-emerald-200">
                                <h3 class="text-xl font-semibold text-emerald-800 mb-3">Your Impact So Far</h3>
                                <p class="text-gray-700">Tokens Earned: <span class="font-bold text-green-600">${tokens}</span></p>
                                <p class="text-gray-700">XP Gained: <span class="font-bold text-green-600">${xp}</span></p>
                                <p class="text-gray-700">Current Level: <span class="font-bold text-green-600">${level}</span></p>
                            </div>
                            <div class="bg-emerald-50 p-5 rounded-lg shadow-md border border-emerald-200">
                                <h3 class="text-xl font-semibold text-emerald-800 mb-3">About JuanDer Quest</h3>
                                <p class="text-gray-700 text-sm">
                                    JuanDer Quest is a gamified, blockchain-based eco-tourism app rewarding eco-friendly behavior with tokens.
                                    These tokens can be redeemed for local shop discounts, donated to heritage sites, or used to level up.
                                    We combine environmental sustainability, local economic empowerment, and Web3 technology for engaging, impactful, and rewarding experiences.
                                </p>
                            </div>
                        </div>
                        <div class="mt-8 text-center">
                            <button
                                id="go-to-home-button"
                                class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transform transition-transform duration-300 hover:scale-105"
                            >
                                Go to Home!
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Renders the Profile View
        function renderProfileView() {
            const nextLevelXpThreshold = LEVEL_THRESHOLDS[level + 1] || xp;
            const progressToNextLevel = level < 10 ? Math.max(0, xp - LEVEL_THRESHOLDS[level]) : 0;
            const totalXpForCurrentLevel = LEVEL_THRESHOLDS[level];
            const totalXpNeededForNextLevel = level < 10 ? (nextLevelXpThreshold - totalXpForCurrentLevel) : 0;
            const progressPercentage = totalXpNeededForNextLevel > 0 ? (progressToNextLevel / totalXpNeededForNextLevel) * 100 : 100;

            const earnedBadges = Array.from(new Set(
                Object.keys(completedQuests)
                    .filter(id => completedQuests[id])
                    .map(id => quests.find(q => q.id === id)?.badge)
                    .filter(Boolean)
            ));

            return `
                <div class="p-6 bg-white rounded-xl shadow-lg mt-6 max-w-4xl mx-auto">
                    <h2 class="text-3xl font-bold text-green-700 mb-6 text-center">Your JuanDerer Profile</h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="bg-emerald-50 p-5 rounded-lg shadow-md border border-emerald-200">
                            <h3 class="text-xl font-semibold text-emerald-800 mb-3">Level & Progress</h3>
                            <p class="text-gray-700 text-lg mb-2">Current Level: <span class="font-bold text-green-600">${level}</span></p>
                            <p class="text-gray-700 text-lg mb-4">Total XP: <span class="font-bold text-green-600">${xp}</span></p>

                            ${level < 10 ? `
                                <p class="text-gray-600 text-sm mb-2">
                                    XP to next level (${level + 1}): <span class="font-bold">${nextLevelXpThreshold - xp}</span>
                                </p>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div
                                        class="bg-green-500 h-3 rounded-full transition-all duration-500 ease-out"
                                        style="width: ${progressPercentage}%"
                                    ></div>
                                </div>
                                <p class="text-right text-xs text-gray-500 mt-1">${Math.round(progressPercentage)}%</p>
                            ` : `
                                <p class="text-green-600 font-bold text-lg">You've reached the maximum level!</p>
                            `}
                        </div>

                        <div class="bg-emerald-50 p-5 rounded-lg shadow-md border border-emerald-200">
                            <h3 class="text-xl font-semibold text-emerald-800 mb-3">Earned Badges</h3>
                            ${earnedBadges.length > 0 ? `
                                <ul class="list-disc list-inside text-gray-700">
                                    ${earnedBadges.map(badge => `
                                        <li class="mb-1">ðŸŒŸ ${badge}</li>
                                    `).join('')}
                                </ul>
                            ` : `
                                <p class="text-gray-600">Complete quests to earn badges!</p>
                            `}
                        </div>
                    </div>

                    <div class="bg-emerald-50 p-5 rounded-lg shadow-md border border-emerald-200">
                        <h3 class="text-xl font-semibold text-emerald-800 mb-3">Completed Quests</h3>
                        ${Object.keys(completedQuests).length > 0 ? `
                            <ul class="list-disc list-inside text-gray-700">
                                ${Object.keys(completedQuests).map(questId => {
                                    const quest = quests.find(q => q.id === questId);
                                    return quest ? `<li class="mb-1">âœ… ${quest.name}</li>` : '';
                                }).join('')}
                            </ul>
                        ` : `
                            <p class="text-gray-600">No quests completed yet. Go out and JuanDer!</p>
                        `}
                    </div>
                </div>
            `;
        }

        // Renders the Token Utility View
        function renderTokenUtilityView() {
            return `
                <div class="p-6 bg-white rounded-xl shadow-lg mt-6 max-w-4xl mx-auto">
                    <h2 class="text-3xl font-bold text-green-700 mb-6 text-center">Token Utility</h2>
                    <p class="text-gray-700 text-lg mb-6 text-center">Your current balance: <span class="font-bold text-green-600">${tokens}</span> Tokens</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-emerald-50 p-5 rounded-lg shadow-md border border-emerald-200">
                            <h3 class="text-xl font-semibold text-emerald-800 mb-3">Redeem for Discounts</h3>
                            <p class="text-gray-700 text-sm mb-4">Use your tokens to get discounts and vouchers at partner local shops.</p>
                            <button
                                id="redeem-50-tokens"
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full shadow-md transform transition-transform duration-300 hover:scale-105"
                            >
                                Redeem 50 Tokens
                            </button>
                        </div>

                        <div class="bg-emerald-50 p-5 rounded-lg shadow-md border border-emerald-200">
                            <h3 class="text-xl font-semibold text-emerald-800 mb-3">Donate to Heritage Sites</h3>
                            <p class="text-gray-700 text-sm mb-4">Support local heritage sites and protected areas with your tokens.</p>
                            <button
                                id="donate-20-tokens"
                                class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-full shadow-md transform transition-transform duration-300 hover:scale-105"
                            >
                                Donate 20 Tokens
                            </button>
                        </div>

                        <div class="bg-emerald-50 p-5 rounded-lg shadow-md border border-emerald-200">
                            <h3 class="text-xl font-semibold text-emerald-800 mb-3">Top-up Tokens</h3>
                            <p class="text-gray-700 text-sm mb-4">Need more tokens for quests or rewards? Purchase them easily!</p>
                            <button
                                id="top-up-100-tokens"
                                class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-full shadow-md transform transition-transform duration-300 hover:scale-105"
                            >
                                Buy 100 Tokens
                            </button>
                        </div>

                        <div class="bg-emerald-50 p-5 rounded-lg shadow-md border border-emerald-200">
                            <h3 class="text-xl font-semibold text-emerald-800 mb-3">Watch Ads for Bonus</h3>
                            <p class="text-gray-700 text-sm mb-4">Watch eco-aligned ads to double your tokens!</p>
                            <button
                                id="watch-ad-double-tokens"
                                class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-full shadow-md transform transition-transform duration-300 hover:scale-105"
                            >
                                Watch Ad (Double Tokens)
                            </button>
                        </div>
                    </div>

                    <div class="mt-8 bg-emerald-50 p-5 rounded-lg shadow-md border border-emerald-200">
                        <h3 class="text-xl font-semibold text-emerald-800 mb-3">Location-Based Experiences</h3>
                        <p class="text-gray-700 text-sm mb-4">
                            Visit specific locations to unlock quizzes, mini-games, and site-specific badges!
                        </p>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <div class="flex-1 bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                                <h4 class="font-semibold text-gray-800 mb-2">Alimango Restaurant Quiz</h4>
                                <p class="text-gray-600 text-sm mb-3">Unlock a quiz about mangrove crabs and earn bonus tokens!</p>
                                <button
                                    id="alimango-quiz-button"
                                    class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-full text-sm shadow-md"
                                >
                                    Take Quiz
                                </button>
                            </div>
                            <div class="flex-1 bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                                <h4 class="font-semibold text-gray-800 mb-2">Hundred Islands Trivia</h4>
                                <p class="text-gray-600 text-sm mb-3">Answer trivia about the islands for a token multiplier!</p>
                                <button
                                    id="hundred-islands-trivia-button"
                                    class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-full text-sm shadow-md"
                                >
                                    Play Trivia
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Renders the dedicated Quest Detail Page
        function renderQuestDetailPage() {
            const quest = quests.find(q => q.id === selectedQuestId);
            if (!quest) {
                return `<div class="p-6 text-center text-red-500">Quest not found!</div>`;
            }

            const isCompleted = completedQuests[quest.id];
            const hasLocation = quest.lat !== null && quest.lon !== null;

            let locationStatusHtml = '';
            if (hasLocation) {
                let statusMessage = '';
                let statusColor = 'text-gray-600';
                let checkButtonDisabled = false;

                switch (locationCheckStatus) {
                    case 'idle':
                        statusMessage = 'Click "Check Location" to verify your proximity.';
                        break;
                    case 'checking':
                        statusMessage = 'Checking your location...';
                        statusColor = 'text-blue-500';
                        checkButtonDisabled = true;
                        break;
                    case 'success':
                        const distance = haversineDistance(userLatitude, userLongitude, quest.lat, quest.lon);
                        const rangeThreshold = 5; // km
                        isInRange = distance <= rangeThreshold;
                        statusMessage = isInRange ?
                            `<span class="font-bold">You are within ${distance.toFixed(2)} km of the quest!</span>` :
                            `<span class="font-bold">You are ${distance.toFixed(2)} km away.</span> (Need to be within ${rangeThreshold} km)`;
                        statusColor = isInRange ? 'text-green-600' : 'text-red-500';
                        break;
                    case 'denied':
                        statusMessage = 'Location access denied. Please enable location services in your browser settings.';
                        statusColor = 'text-red-500';
                        break;
                    case 'error':
                        statusMessage = 'Could not get your location. Please try again.';
                        statusColor = 'text-red-500';
                        break;
                }

                locationStatusHtml = `
                    <div class="bg-blue-50 p-4 rounded-lg shadow-inner border border-blue-200 mb-6">
                        <h3 class="text-lg font-semibold text-blue-800 mb-2">Location Verification</h3>
                        <p class="text-sm ${statusColor} mb-3">${statusMessage}</p>
                        <button id="check-location-button"
                                class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full text-sm shadow-md transition-transform duration-300 hover:scale-105
                                ${checkButtonDisabled ? 'opacity-50 cursor-not-allowed' : ''}"
                                ${checkButtonDisabled ? 'disabled' : ''}>
                            ${locationCheckStatus === 'checking' ? 'Locating...' : 'Check My Location'}
                        </button>
                        ${userLatitude && userLongitude ? `
                            <p class="text-xs text-gray-500 mt-2">Your location: Lat ${userLatitude.toFixed(4)}, Lon ${userLongitude.toFixed(4)}</p>
                        ` : ''}
                        <p class="text-xs text-gray-500 mt-1">Quest location: Lat ${quest.lat}, Lon ${quest.lon}</p>
                    </div>
                `;
            } else {
                locationStatusHtml = `
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200 mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Location Verification</h3>
                        <p class="text-sm text-gray-600">This quest does not require location verification.</p>
                    </div>
                `;
                isInRange = true; // Automatically true for quests without location
            }


            return `
                <div class="p-6 bg-white rounded-xl shadow-lg mt-6 max-w-4xl mx-auto">
                    <button id="back-to-home-button" class="mb-4 text-green-600 hover:underline flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                        Back to Home
                    </button>
                    <h2 class="text-3xl font-bold text-green-700 mb-4 text-center">${quest.name}</h2>
                    <p class="text-gray-600 text-center mb-6">${quest.category} - ${quest.location}</p>

                    <div class="bg-emerald-50 p-5 rounded-lg shadow-md border border-emerald-200 mb-6">
                        <h3 class="text-xl font-semibold text-emerald-800 mb-3">Details</h3>
                        <p class="text-gray-700 mb-2">${quest.description}</p>
                        <p class="text-gray-700 mb-2"><strong>Reward:</strong> ðŸ’° ${quest.rewardTokens} Tokens, âœ¨ ${quest.rewardXp} XP</p>
                        <p class="text-gray-700 mb-2"><strong>Badge:</strong> ${quest.badge}</p>
                        <div class="flex items-center text-yellow-500 text-sm">
                            ${Array.from({ length: 5 }).map((_, i) => `
                                <svg key="${i}" class="h-5 w-5 ${i < Math.floor(quest.rating) ? 'text-yellow-500' : 'text-gray-300'}" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.538 1.118l-2.8-2.034a1 1 0 00-1.176 0l-2.8 2.034c-.783.57-1.838-.197-1.538-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.462a1 1 0 00.95-.69l1.07-3.292z" />
                                </svg>
                            `).join('')}
                            <span class="ml-1 text-gray-600">(${quest.rating})</span>
                        </div>
                    </div>

                    ${locationStatusHtml}

                    ${isCompleted ? `
                        <p class="text-center text-green-600 font-bold text-xl mt-8">Quest Completed!</p>
                    ` : `
                        <button id="complete-quest-button" data-quest-id="${quest.id}"
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transform transition-transform duration-300 hover:scale-105 mt-8
                            ${!isInRange && hasLocation ? 'opacity-50 cursor-not-allowed' : ''}"
                            ${!isInRange && hasLocation ? 'disabled' : ''}>
                            Complete Quest
                        </button>
                    `}
                </div>
            `;
        }


        // Renders the Start Page
        function renderStartPage() {
            return `
                <div id="start-page" class="fixed inset-0 bg-gradient-to-br from-green-500 to-emerald-700 flex flex-col items-center justify-center z-[100] text-white p-4 text-center">
                    <img
                        src="https://via.placeholder.com/600x100.png?text=JuanDer+Quest+Logo"
                        alt="JuanDer Quest Logo"
                        class="w-full max-w-xl mb-8 animate-fade-in-up rounded-lg shadow-lg"
                        onerror="this.onerror=null;this.src='https://via.placeholder.com/600x100.png?text=JuanDer+Quest+Logo+Fallback';"
                    />
                    ${isAnimatingLoading ? `
                        <div class="flex flex-col items-center">
                            <p class="text-xl font-semibold mb-4">Preparing your adventure...</p>
                            <div class="progress-bar-container w-64 h-6 bg-gray-200 rounded-full overflow-hidden shadow-inner">
                                <div class="progress-bar-fill h-full rounded-full bg-gradient-to-r from-lime-400 to-green-600"></div>
                            </div>
                        </div>
                    ` : `
                        <button
                            id="start-adventure-button"
                            class="bg-white text-green-700 font-bold py-4 px-8 rounded-full shadow-lg
                            transform transition-all duration-300 hover:scale-105 hover:bg-green-100
                            focus:outline-none focus:ring-4 focus:ring-green-300 animate-pop-in
                            flex items-center justify-center space-x-3"
                        >
                            <span class="text-xl">Start Your Adventure</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    `}
                </div>
            `;
        }

        // Renders the Connect Wallet View
        function renderConnectWalletView() {
            return `
                <div class="p-6 bg-white rounded-xl shadow-lg mt-6 max-w-md mx-auto text-center">
                    <h2 class="text-3xl font-bold text-green-700 mb-6">Connect Your Wallet</h2>
                    <p class="text-gray-700 mb-6">
                        To access JuanDer Quest, please connect your MetaMask wallet and provide a username.
                    </p>

                    <div class="mb-6">
                        <label for="username-input" class="block text-left text-gray-700 text-sm font-bold mb-2">Username:</label>
                        <input type="text" id="username-input" placeholder="Enter your username" value="${username}"
                               class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>

                    <button id="connect-wallet-button"
                            class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transform transition-transform duration-300 hover:scale-105 flex items-center justify-center space-x-2">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" alt="MetaMask icon" class="h-6 w-6">
                        <span>Connect MetaMask Wallet</span>
                    </button>
                    <p id="wallet-status" class="mt-4 text-sm text-gray-600">
                        ${connectedWalletAddress ? `Connected: ${connectedWalletAddress.substring(0, 6)}...${connectedWalletAddress.substring(connectedWalletAddress.length - 4)}` : 'Wallet not connected.'}
                    </p>
                </div>
            `;
        }

        // --- Main Application Rendering ---

        let isAnimatingLoading = false; // Local state for StartPage animation

        function renderApp() {
            const appRoot = document.getElementById('app-root');
            if (!appRoot) return;

            let mainContentHtml = '';
            const mainPaddingClass = 'pt-4 md:pt-6'; // Consistent padding for all main content areas

            if (showStartPage) {
                htmlContent = renderStartPage();
                appRoot.innerHTML = htmlContent;
                // Add event listener for start button after rendering
                const startButton = document.getElementById('start-adventure-button');
                if (startButton) {
                    startButton.onclick = () => {
                        isAnimatingLoading = true;
                        renderApp(); // Re-render to show loading bar
                        setTimeout(() => {
                            showStartPage = false;
                            // After start page, always go to connect wallet if not already connected
                            activeView = connectedWalletAddress && username ? 'home' : 'connect-wallet';
                            isAnimatingLoading = false; // Reset loading state
                            renderApp(); // Render main app or connect wallet view
                        }, 2000);
                    };
                }
            } else {
                // If not showing start page and wallet is not connected OR username is missing, force connect-wallet view
                if (!connectedWalletAddress || !username && activeView !== 'connect-wallet') {
                    activeView = 'connect-wallet';
                }

                switch (activeView) {
                    case 'connect-wallet':
                        mainContentHtml = renderConnectWalletView();
                        break;
                    case 'home':
                        mainContentHtml = renderHomeView();
                        break;
                    case 'quests':
                        mainContentHtml = renderQuestsView();
                        break;
                    case 'profile':
                        mainContentHtml = renderProfileView();
                        break;
                    case 'token-utility':
                        mainContentHtml = renderTokenUtilityView();
                        break;
                    case 'quest-detail':
                        mainContentHtml = renderQuestDetailPage();
                        break;
                    default:
                        // Fallback to connect-wallet if something goes wrong and wallet isn't connected
                        mainContentHtml = renderConnectWalletView();
                }

                const mobileNavToggleHtml = (activeView !== 'connect-wallet') ? `
                    <button id="mobile-nav-toggle" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-green-600 hover:bg-green-700 text-white text-lg font-bold py-3 px-6 rounded-full shadow-xl transform transition-transform duration-300 hover:scale-105 z-[99] flex items-center justify-center w-16 h-16">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 transition-all duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            ${isNavOverlayOpen ? `<path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />` : `<path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />`}
                        </svg>
                    </button>
                    ${renderNavOverlay()}
                ` : ''; // Hide nav toggle if on connect-wallet page

                htmlContent = `
                    <main class="container mx-auto px-4 flex-grow pb-20 md:pb-8 ${mainPaddingClass}">
                        ${mainContentHtml}
                    </main>
                    ${mobileNavToggleHtml}
                `;
                appRoot.innerHTML = htmlContent;

                // Attach event listeners after rendering
                attachEventListeners();
            }
        }

        function attachEventListeners() {
            // Mobile Nav Toggle Button (now primary navigation) - only attach if it exists
            const mobileNavToggleButton = document.getElementById('mobile-nav-toggle');
            if (mobileNavToggleButton) {
                mobileNavToggleButton.onclick = () => {
                    isNavOverlayOpen = !isNavOverlayOpen;
                    renderApp();
                };
            }

            // Mobile Nav Overlay buttons
            const navOverlay = document.getElementById('nav-overlay');
            if (navOverlay) {
                navOverlay.onclick = (event) => {
                    if (event.target.id === 'nav-overlay') {
                        isNavOverlayOpen = false;
                        renderApp();
                    }
                };
                navOverlay.querySelectorAll('.nav-overlay-content button').forEach(button => {
                    button.onclick = (event) => {
                        activeView = event.currentTarget.dataset.view;
                        isNavOverlayOpen = false;
                        renderApp();
                    };
                });
            }

            // Connect Wallet button (now the primary entry point)
            const connectWalletButton = document.getElementById('connect-wallet-button');
            if (connectWalletButton) {
                connectWalletButton.onclick = async () => {
                    const usernameInput = document.getElementById('username-input');
                    if (!usernameInput || !usernameInput.value.trim()) {
                        alert("Please enter a username.");
                        return;
                    }
                    username = usernameInput.value.trim(); // Store the username

                    if (window.ethereum) {
                        try {
                            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                            connectedWalletAddress = accounts[0];
                            alert(`Wallet connected: ${connectedWalletAddress} with username: ${username}`);
                            activeView = 'home'; // Automatically go to home after successful connection and username entry
                            renderApp();
                        } catch (error) {
                            console.error("User denied account access or other error:", error);
                            alert("Failed to connect wallet. Please ensure MetaMask is unlocked and try again.");
                        }
                    } else {
                        alert("MetaMask is not installed. Please install it to connect your wallet.");
                    }
                };
            }

            // Quest card click handler in Home View
            document.querySelectorAll('[data-quest-id]').forEach(card => {
                card.onclick = (event) => {
                    selectedQuestId = event.currentTarget.dataset.questId;
                    activeView = 'quest-detail';
                    locationCheckStatus = 'idle'; // Reset status when navigating to a new quest detail
                    isInRange = false; // Reset range status
                    renderApp();
                };
            });

            // Back to Home button on Quest Detail Page
            const backToHomeButton = document.getElementById('back-to-home-button');
            if (backToHomeButton) {
                backToHomeButton.onclick = () => {
                    activeView = 'home';
                    selectedQuestId = null; // Clear selected quest
                    renderApp();
                };
            }

            // Complete Quest button on Quest Detail Page
            const completeQuestButton = document.getElementById('complete-quest-button');
            if (completeQuestButton) {
                completeQuestButton.onclick = (event) => {
                    const questId = event.currentTarget.dataset.questId;
                    handleCompleteQuest(questId);
                };
            }

            // Check Location button on Quest Detail Page
            const checkLocationButton = document.getElementById('check-location-button');
            if (checkLocationButton) {
                checkLocationButton.onclick = () => {
                    getUserLocation(() => {
                        // Callback to re-render after location check is complete
                        renderApp();
                    });
                };
            }

            // Go to Home button on Quests View
            const goToHomeButton = document.getElementById('go-to-home-button');
            if (goToHomeButton) {
                goToHomeButton.onclick = () => {
                    activeView = 'home';
                    renderApp();
                };
            }

            // Token Utility buttons
            const redeemButton = document.getElementById('redeem-50-tokens');
            if (redeemButton) redeemButton.onclick = () => redeemTokens(50);

            const donateButton = document.getElementById('donate-20-tokens');
            if (donateButton) donateButton.onclick = () => donateTokens(20);

            const topUpButton = document.getElementById('top-up-100-tokens');
            if (topUpButton) topUpButton.onclick = () => addTokens(100, 'Top-up');

            const watchAdButton = document.getElementById('watch-ad-double-tokens');
            if (watchAdButton) watchAdButton.onclick = () => addTokens(tokens, 'Watching Ad');

            const alimangoQuizButton = document.getElementById('alimango-quiz-button');
            if (alimangoQuizButton) alimangoQuizButton.onclick = () => addTokens(30, 'Alimango Quiz');

            const hundredIslandsTriviaButton = document.getElementById('hundred-islands-trivia-button');
            if (hundredIslandsTriviaButton) hundredIslandsTriviaButton.onclick = () => addTokens(tokens * 0.5, 'Hundred Islands Trivia');
        }

        // Initial render when the window loads
        window.onload = renderApp;

    </script>
</body>
</html>
